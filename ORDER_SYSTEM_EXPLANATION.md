# ุดุฑุญ ูุธุงู ุงูุทูุจุงุช (Order System)

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงูุทูุจุงุช ูุชุนุงูู ูุน ุฅูุดุงุก ูุฅุฏุงุฑุฉ ุงูุทูุจุงุช ูู ุงูุณูุฉ (Cart) ุฅูู ุงูุชุณููู. ุงููุธุงู ูุฏุนู:
- ุทูุจุงุช ูุชุนุฏุฏุฉ ุงูุชุงุฌุฑ (Multi-vendor orders)
- ุทุฑู ุฏูุน ูุฎุชููุฉ (Wallet, Cash, Card)
- ุชุชุจุน ุญุงูุฉ ุงูุทูุจ
- ุฅุดุนุงุฑุงุช ูููุณุชุฎุฏู ูุงูุชุงุฌุฑ

---

## ๐๏ธ ุงูุจููุฉ (Architecture)

### Models:
1. **Order** - ุงูุทูุจ ุงูุฑุฆูุณู
   - `userId`: ุงููุณุชุฎุฏู ุงูุฐู ุทูุจ
   - `vendorId`: ุงูุชุงุฌุฑ ุตุงุญุจ ุงูููุชุฌุงุช
   - `status`: ุญุงูุฉ ุงูุทูุจ (pending, confirmed, processing, shipped, delivered, cancelled)
   - `total`: ุฅุฌูุงูู ุงููุจูุบ
   - `shippingAddress`: ุนููุงู ุงูุดุญู
   - `paymentMethod`: ุทุฑููุฉ ุงูุฏูุน (wallet, cash, card)
   - `paymentStatus`: ุญุงูุฉ ุงูุฏูุน (pending, paid, failed, refunded)

2. **OrderItem** - ุนูุงุตุฑ ุงูุทูุจ
   - `orderId`: ูุนุฑู ุงูุทูุจ
   - `productId`: ูุนุฑู ุงูููุชุฌ
   - `quantity`: ุงููููุฉ
   - `price`: ุงูุณุนุฑ (ุจุนุฏ ุงูุฎุตู)
   - `subtotal`: ุงููุฌููุน ุงููุฑุนู

---

## ๐ ุชุฏูู ุฅูุดุงุก ุงูุทูุจ (Create Order Flow)

### 1. ุงููุณุชุฎุฏู ูุถุบุท "ุฅูุดุงุก ุทูุจ"
```
POST /api/v1/orders
Headers: Authorization: Bearer {token}
Body: {
  "shippingAddress": "ุงูุนููุงู ุงููุงูู",
  "paymentMethod": "wallet" // ุฃู "cash" ุฃู "card"
}
```

### 2. ูุง ูุญุฏุซ ูู `createOrder` Controller:

#### ุงูุฎุทูุฉ 2.1: ุฌูุจ ุนูุงุตุฑ ุงูุณูุฉ
```javascript
const cartItems = await cartService.getCart(userId);
// Returns: [{ productId, quantity }, ...]
```

#### ุงูุฎุทูุฉ 2.2: ุงูุชุญูู ูู ุฃู ุงูุณูุฉ ููุณุช ูุงุฑุบุฉ
```javascript
if (cartItems.length === 0) {
  return sendError(res, 'Cart is empty', 400);
}
```

#### ุงูุฎุทูุฉ 2.3: ุชุญููู ุนูุงุตุฑ ุงูุณูุฉ ุฅูู ุชูุณูู ุงูุทูุจ
```javascript
const orderItems = cartItems.map(item => ({
  productId: item.productId,
  quantity: item.quantity
}));
```

#### ุงูุฎุทูุฉ 2.4: ุงุณุชุฏุนุงุก Service ูุฅูุดุงุก ุงูุทูุจ
```javascript
const orders = await orderService.createOrder(
  userId, 
  orderItems, 
  shippingAddress, 
  paymentMethod
);
```

---

## ๐ฏ ูุง ูุญุฏุซ ูู `orderService.createOrder`:

### ุงููุฑุญูุฉ 1: ุชุฌููุน ุงูููุชุฌุงุช ุญุณุจ ุงูุชุงุฌุฑ

```javascript
// Group items by vendor
const vendorGroups = {};
// Result: {
//   "5": [{ productId: 1, quantity: 2, price: 100, subtotal: 200 }, ...],
//   "7": [{ productId: 3, quantity: 1, price: 50, subtotal: 50 }, ...]
// }
```

**ููุงุฐุงุ** ูุฃู ูู ุชุงุฌุฑ ูู ุทูุจ ูููุตู!

### ุงููุฑุญูุฉ 2: ุญุณุงุจ ุงูุฃุณุนุงุฑ

ููู ููุชุฌ:
1. ุฌูุจ ูุนูููุงุช ุงูููุชุฌ (ุงูุณุนุฑุ ุงูุฎุตู)
2. ุญุณุงุจ ุงูุณุนุฑ ุจุนุฏ ุงูุฎุตู: `discountedPrice = price * (1 - discount / 100)`
3. ุญุณุงุจ ุงููุฌููุน ุงููุฑุนู: `subtotal = discountedPrice * quantity`
4. ุฅุถุงูุฉ ุฅูู ุฅุฌูุงูู ุงููุจูุบ

### ุงููุฑุญูุฉ 3: ุฅูุดุงุก ุทูุจ ููู ุชุงุฌุฑ

ููู ุชุงุฌุฑ:

#### 3.1: ุงูุชุญูู ูู ุฑุตูุฏ ุงููุญูุธุฉ (ุฅุฐุง ูุงู ุงูุฏูุน ุจู wallet)
```javascript
if (paymentMethod === 'wallet') {
  const balance = await walletService.getBalance(userId);
  if (balance < vendorTotal) {
    throw new Error('Insufficient wallet balance');
  }
  await walletService.deductBalance(userId, vendorTotal);
}
```

#### 3.2: ุฅูุดุงุก ุงูุทูุจ
```javascript
const order = await Order.create({
  userId,
  vendorId: parseInt(vendorId),
  status: 'pending',
  total: vendorTotal,
  shippingAddress,
  paymentMethod,
  paymentStatus: paymentMethod === 'wallet' ? 'paid' : 'pending'
});
```

#### 3.3: ุฅูุดุงุก ุนูุงุตุฑ ุงูุทูุจ
```javascript
for (const item of items) {
  await OrderItem.create({
    orderId: order.id,
    productId: item.productId,
    quantity: item.quantity,
    price: item.price,
    subtotal: item.subtotal
  });
}
```

#### 3.4: ุฅุฑุณุงู ุฅุดุนุงุฑ ููุชุงุฌุฑ
```javascript
await notificationService.notifyVendorNewOrder(
  vendorId,
  order.id,
  user.name,
  vendorTotal
);
```

### ุงููุฑุญูุฉ 4: ุฅุดุนุงุฑ ุงููุณุชุฎุฏู
```javascript
await notificationService.notifyOrderCreated(
  userId, 
  orders[0]?.id, 
  totalOrderAmount
);
```

### ุงููุฑุญูุฉ 5: ูุณุญ ุงูุณูุฉ
```javascript
await cartService.clearCart(userId);
```

---

## ๐ ุญุงูุงุช ุงูุทูุจ (Order Status Flow)

```
pending โ confirmed โ processing โ shipped โ delivered
    โ
cancelled
```

- **pending**: ุงูุทูุจ ุฌุฏูุฏ (ูู ุงูุชุธุงุฑ ุงูุชุฃููุฏ)
- **confirmed**: ุชู ุชุฃููุฏ ุงูุทูุจ ูู ุงูุชุงุฌุฑ
- **processing**: ุงูุชุงุฌุฑ ูุนุงูุฌ ุงูุทูุจ
- **shipped**: ุชู ุงูุดุญู
- **delivered**: ุชู ุงูุชุณููู
- **cancelled**: ุชู ุงูุฅูุบุงุก

---

## ๐ ุงูุตูุงุญูุงุช (Authorization)

### `getOrderById`:
- ุฃู ูุณุชุฎุฏู ูุตุงุฏู ุนููู ููููู ุฑุคูุฉ ุงูุทูุจ (ุฅุฐุง ูุงู ูู ุงููุงูู ุฃู ุงูุชุงุฌุฑ)

### `getUserOrders`:
- ุงููุณุชุฎุฏู ููุท ููููู ุฑุคูุฉ ุทูุจุงุชู

### `getVendorOrders`:
- ุงูุชุงุฌุฑ ููุท ููููู ุฑุคูุฉ ุทูุจุงุชู

### `updateOrderStatus`:
- ุงูุชุงุฌุฑ ุตุงุญุจ ุงูุทูุจ ุฃู Admin ููุท ููููู ุชุญุฏูุซ ุงูุญุงูุฉ

### `cancelOrder`:
- ุงููุณุชุฎุฏู ุตุงุญุจ ุงูุทูุจ ููุท ููููู ุฅูุบุงุก ุงูุทูุจ

---

## ๐ฐ ูุนุงูุฌุฉ ุงูุฏูุน (Payment Handling)

### Wallet Payment:
1. ุงูุชุญูู ูู ุงูุฑุตูุฏ
2. ุฎุตู ุงููุจูุบ ูู ุงููุญูุธุฉ
3. `paymentStatus = 'paid'`

### Cash/Card Payment:
1. `paymentStatus = 'pending'`
2. ูุชู ุงูุฏูุน ุนูุฏ ุงูุชุณููู

### ุนูุฏ ุงูุฅูุบุงุก (ุฅุฐุง ูุงู ูุฏููุน):
```javascript
if (order.paymentMethod === 'wallet' && order.paymentStatus === 'paid') {
  await walletService.addBalance(userId, order.total);
  order.paymentStatus = 'refunded';
}
```

---

## ๐ฑ ุงูุฅุดุนุงุฑุงุช (Notifications)

### ุนูุฏ ุฅูุดุงุก ุงูุทูุจ:
- โ ุฅุดุนุงุฑ ููุชุงุฌุฑ: "ุทูุจ ุฌุฏูุฏ ูู [ุงุณู ุงููุณุชุฎุฏู]"
- โ ุฅุดุนุงุฑ ูููุณุชุฎุฏู: "ุชู ุฅูุดุงุก ุทูุจู ุจูุฌุงุญ"

### ุนูุฏ ุชุญุฏูุซ ุงูุญุงูุฉ:
- โ ุฅุดุนุงุฑ ูููุณุชุฎุฏู: "ุชู ุชุญุฏูุซ ุญุงูุฉ ุทูุจู ุฅูู [ุงูุญุงูุฉ]"
- โ ุนูุฏ ุงูุชุณููู: ุฅุดุนุงุฑ ุฎุงุต + ุฅุดุนุงุฑ ููุชุงุฌุฑ ุจุงูุฏูุน

### ุนูุฏ ุงูุฅูุบุงุก:
- โ ุฅุดุนุงุฑ ูููุณุชุฎุฏู: "ุชู ุฅูุบุงุก ุทูุจู"

---

## ๐ Endpoints Overview

### 1. `POST /api/v1/orders` - ุฅูุดุงุก ุทูุจ
**ุงููุณุชุฎุฏู:** User
**ุงููุฏุฎูุงุช:**
- `shippingAddress`: ุนููุงู ุงูุดุญู
- `paymentMethod`: ุทุฑููุฉ ุงูุฏูุน (ุงุฎุชูุงุฑูุ ุงูุชุฑุงุถู: 'wallet')

**ูุง ูุญุฏุซ:**
1. ุฌูุจ ุนูุงุตุฑ ุงูุณูุฉ
2. ุชุฌููุน ุญุณุจ ุงูุชุงุฌุฑ
3. ุญุณุงุจ ุงูุฃุณุนุงุฑ
4. ุฎุตู ูู ุงููุญูุธุฉ (ุฅุฐุง ูุงู wallet)
5. ุฅูุดุงุก ุทูุจุงุช ูุชุนุฏุฏุฉ (ูุงุญุฏ ููู ุชุงุฌุฑ)
6. ุฅุฑุณุงู ุฅุดุนุงุฑุงุช
7. ูุณุญ ุงูุณูุฉ

**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "statusCode": 201,
  "data": [
    {
      "id": 1,
      "userId": 10,
      "vendorId": 5,
      "status": "pending",
      "total": 200.00,
      "items": [...]
    },
    {
      "id": 2,
      "userId": 10,
      "vendorId": 7,
      "status": "pending",
      "total": 50.00,
      "items": [...]
    }
  ]
}
```

---

### 2. `GET /api/v1/orders/:id` - ุงูุญุตูู ุนูู ุทูุจ ูุนูู
**ุงููุณุชุฎุฏู:** User/Vendor
**ุงูุงุณุชุฌุงุจุฉ:** ุชูุงุตูู ุงูุทูุจ ูุน ุงูุนูุงุตุฑ

---

### 3. `GET /api/v1/orders/my-orders` - ุทูุจุงุช ุงููุณุชุฎุฏู
**ุงููุณุชุฎุฏู:** User
**ุงูุงุณุชุฌุงุจุฉ:** ุฌููุน ุทูุจุงุช ุงููุณุชุฎุฏู

---

### 4. `GET /api/v1/orders/vendor-orders` - ุทูุจุงุช ุงูุชุงุฌุฑ
**ุงููุณุชุฎุฏู:** Vendor
**ุงูุงุณุชุฌุงุจุฉ:** ุฌููุน ุทูุจุงุช ุงูุชุงุฌุฑ

---

### 5. `PUT /api/v1/orders/:id/status` - ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
**ุงููุณุชุฎุฏู:** Vendor/Admin
**ุงููุฏุฎูุงุช:**
```json
{
  "status": "confirmed" // ุฃู processing, shipped, delivered
}
```

**ูุง ูุญุฏุซ:**
1. ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
2. ุงูุชุญูู ูู ุตุญุฉ ุงูุญุงูุฉ
3. ุชุญุฏูุซ ุงูุญุงูุฉ
4. ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู
5. ุฅุฐุง ูุงูุช ุงูุญุงูุฉ "delivered" ููุฏููุน: ุฅุดุนุงุฑ ููุชุงุฌุฑ ุจุงูุฏูุน

---

### 6. `PUT /api/v1/orders/:id/cancel` - ุฅูุบุงุก ุงูุทูุจ
**ุงููุณุชุฎุฏู:** User (ุตุงุญุจ ุงูุทูุจ)
**ูุง ูุญุฏุซ:**
1. ุงูุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูู ุตุงุญุจ ุงูุทูุจ
2. ุงูุชุญูู ูู ุฃู ุงูุทูุจ ูุงุจู ููุฅูุบุงุก (ููุณ delivered ุฃู cancelled)
3. ุฅุฐุง ูุงู ูุฏููุน: ุงุณุชุฑุฏุงุฏ ุงููุจูุบ
4. ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "cancelled"
5. ุฅุฑุณุงู ุฅุดุนุงุฑ

---

## ๐ฏ ูุซุงู ุนูู ุงูุชุฏูู ุงููุงูู

### ุงูุณููุงุฑูู: ูุณุชุฎุฏู ูุฏูู ููุชุฌุงุช ูู ุชุงุฌุฑูู ูู ุงูุณูุฉ

#### 1. ุงูุณูุฉ:
```
- Product 1 (Vendor 5): Quantity 2, Price 100
- Product 2 (Vendor 5): Quantity 1, Price 50
- Product 3 (Vendor 7): Quantity 1, Price 30
```

#### 2. ุนูุฏ ุฅูุดุงุก ุงูุทูุจ:

**Vendor 5:**
- Order 1: Total = 250 (200 + 50)
- Items: [Product 1 ร 2, Product 2 ร 1]

**Vendor 7:**
- Order 2: Total = 30
- Items: [Product 3 ร 1]

**ุงูุฅุฌูุงูู:** 280 ุฌููู

#### 3. ุฅุฐุง ูุงู ุงูุฏูุน ุจู Wallet:
- ุฎุตู 250 ูู ุงููุญูุธุฉ (ูู Order 1)
- ุฎุตู 30 ูู ุงููุญูุธุฉ (ูู Order 2)
- `paymentStatus = 'paid'` ูููุง ุงูุทูุจูู

#### 4. ุงูุฅุดุนุงุฑุงุช:
- Vendor 5: "ุทูุจ ุฌุฏูุฏ ุจูููุฉ 250 ุฌููู"
- Vendor 7: "ุทูุจ ุฌุฏูุฏ ุจูููุฉ 30 ุฌููู"
- User: "ุชู ุฅูุดุงุก ุทูุจู ุจูุฌุงุญ - ุฅุฌูุงูู: 280 ุฌููู"

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **Multi-Vendor Orders**: ูู ุชุงุฌุฑ ูู ุทูุจ ูููุตู
2. **Wallet Balance**: ูุชู ุงูุชุญูู ูู ุงูุฑุตูุฏ ููู ุทูุจ ุนูู ุญุฏุฉ
3. **Cart Clearing**: ูุชู ูุณุญ ุงูุณูุฉ ุจุนุฏ ุฅูุดุงุก ุงูุทูุจ
4. **Notifications**: ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ุนูุฏ ูู ุชุบููุฑ
5. **Refunds**: ุนูุฏ ุงูุฅูุบุงุกุ ูุชู ุงุณุชุฑุฏุงุฏ ุงููุจูุบ ุชููุงุฆูุงู (ุฅุฐุง ูุงู ูุฏููุน)

---

## ๐ง ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ

1. **ุฅุถุงูุฉ Shipping Cost**: ูููู ุฅุถุงูุฉ ุชูููุฉ ุงูุดุญู ุจูุงุกู ุนูู ุงููุฏู
2. **Order History**: ุญูุธ ุชุงุฑูุฎ ุงูุชุบููุฑุงุช
3. **Order Tracking**: ุฑูู ุชุชุจุน ููุดุญู
4. **Partial Cancellation**: ุฅูุบุงุก ุฌุฒุฆู ููุทูุจ
5. **Order Reviews**: ุชููููุงุช ุจุนุฏ ุงูุชุณููู

---

## ๐ ููุฎุต

ูุธุงู ุงูุทูุจุงุช ูุฏุนู:
- โ ุทูุจุงุช ูุชุนุฏุฏุฉ ุงูุชุงุฌุฑ
- โ ุทุฑู ุฏูุน ูุชุนุฏุฏุฉ
- โ ุชุชุจุน ุงูุญุงูุฉ
- โ ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ
- โ ุงุณุชุฑุฏุงุฏ ุชููุงุฆู ุนูุฏ ุงูุฅูุบุงุก
- โ ุตูุงุญูุงุช ูุญููุฉ

ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐

